name: PROD_DEPLOY

on:
  push:
    branches: [main]

jobs:
  Build:
    runs-on: self-hosted

    steps:
      - uses: actions/checkout@v2
      - name: Get microservice image name
        id: get_image_name
        run: echo "::set-output name=image_name::$(cat package.json | jq -r '.name')"

      - name: Get microservice image version
        id: get_image_version
        run: echo "::set-output name=image_version::$(cat package.json | jq -r '.version')"

      - name: Login docker hub
        run: echo "${{ secrets.DOCKER_HUB_PASSWORD }}" | docker login -u ${{ secrets.DOCKER_HUB_USERNAME }} --password-stdin

      - name: Build docker image
        run: docker build -t ${{ steps.get_image_name.outputs.image_name }} .

      - name: Tag container image version
        run: docker tag ${{ steps.get_image_name.outputs.image_name }} "${{ secrets.DOCKER_HUB_USERNAME }}/${{ steps.get_image_name.outputs.image_name }}:${{ steps.get_image_version.outputs.image_version }}"

      - name: Promote container image as latest
        run: docker tag ${{ steps.get_image_name.outputs.image_name }} "${{ secrets.DOCKER_HUB_USERNAME }}/${{ steps.get_image_name.outputs.image_name }}:latest"

      - name: Push version container image
        run: docker push "${{ secrets.DOCKER_HUB_USERNAME }}/${{ steps.get_image_name.outputs.image_name }}:${{ steps.get_image_version.outputs.image_version }}"

      - name: Push latest container image
        run: docker push "${{ secrets.DOCKER_HUB_USERNAME }}/${{ steps.get_image_name.outputs.image_name }}:latest"

      - name: Show built docker images
        run: docker images

      - name: Remove container images from builder
        run: docker rmi "${{ secrets.DOCKER_HUB_USERNAME }}/${{ steps.get_image_name.outputs.image_name }}:${{ steps.get_image_version.outputs.image_version }}" "${{ secrets.DOCKER_HUB_USERNAME }}/${{ steps.get_image_name.outputs.image_name }}:latest"

      - name: Show docker images clean up
        run: docker images

